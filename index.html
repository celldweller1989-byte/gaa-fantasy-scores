<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAA Fantasy - OrchardFans</title>
    <style>
        :root { 
            --orange: #f37021; 
            --dark: #1a1a1a; 
            --cream: #f4f1de; 
            --white: #ffffff;
        }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--cream); margin: 0; padding: 20px; color: var(--dark); }
        
        .header { background: var(--orange); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; border-bottom: 5px solid var(--dark); }
        
        .main-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; max-width: 1200px; margin: 0 auto; }
        
        .panel { background: var(--white); border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        
        .stats-bar { display: flex; justify-content: space-around; font-weight: bold; font-size: 1.1em; margin-top: 10px; }

        /* Market Table */
        .scroll-box { max-height: 600px; overflow-y: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #eee; padding: 12px; text-align: left; font-size: 0.9em; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        
        .btn-add { background: var(--orange); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-add:hover { background: var(--dark); }

        /* Squad List */
        .squad-slot { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 4px solid var(--orange); }
        .btn-remove { color: #ff4d4d; border: none; background: none; font-weight: bold; cursor: pointer; font-size: 1.2em; }

        /* Submission Form */
        #submission-form { margin-top: 20px; padding-top: 20px; border-top: 2px dashed var(--orange); }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8em; font-weight: bold; margin-bottom: 5px; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .btn-submit { background: #28a745; color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; font-weight: bold; font-size: 1em; cursor: pointer; transition: 0.3s; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

        @media (max-width: 850px) { .main-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="header">
    <h1>ORCHARD FANS FANTASY GAA</h1>
    <div class="stats-bar">
        <span>BUDGET: <span id="budget-val">100.0</span>m</span>
        <span>SQUAD: <span id="count-val">0</span>/18</span>
    </div>
</div>

<div class="main-layout">
    <div class="panel">
        <h3>Transfer Market</h3>
        <input type="text" id="playerSearch" placeholder="Search by player or county..." onkeyup="filterTable()">
        <div class="scroll-box">
            <table>
                <thead>
                    <tr><th>Player</th><th>County</th><th>Pos</th><th>Price</th><th>Action</th></tr>
                </thead>
                <tbody id="market-body">
                    <tr><td colspan="5" style="text-align:center;">Loading player database...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <h3>Your 18-Man Squad</h3>
        <div id="squad-list">
            <p style="color:#888; text-align:center; padding:20px;">Your squad is empty. Add players from the market.</p>
        </div>
        
        <div id="submission-form" style="display:none;">
            <div class="input-group">
                <label>MANAGER NAME</label>
                <input type="text" id="mgr-name" placeholder="e.g. Joe Bloggs">
            </div>
            <div class="input-group">
                <label>TEAM NAME</label>
                <input type="text" id="team-name" placeholder="e.g. Crossmaglen Rangers">
            </div>
            <button id="submit-button" class="btn-submit" onclick="sendTeamToGoogle()">SUBMIT SQUAD</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const playersUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcdzjZ4zYlGgFe5acS8xOb1vHR9b8i98UudIOe-iC9Z1d6x6AY5zATgX217cNjcNtAGDLJ56y8Jr8N/pub?output=csv';
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxWGRd9S7MBrO3ST-kzLW05Ztp1FWbTgxGyk8vn8wi_fkWpbjOUwFpAajZGNMX03zLzyA/exec';

    let state = { budget: 100.0, squad: [] };
    let masterDatabase = [];

    // Load Data
    async function init() {
        try {
            const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(playersUrl)}`);
            const csvText = await response.text();
            const rows = csvText.split('\n').slice(1);
            
            masterDatabase = rows.map(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cols.length < 8) return null;
                return {
                    name: `${cols[1]} ${cols[2]}`.replace(/"/g, '').trim(),
                    county: cols[0].replace(/"/g, '').trim(),
                    pos: cols[7].trim(),
                    price: 5.5 // Default price
                };
            }).filter(p => p !== null);
            
            renderMarket(masterDatabase);
        } catch (err) {
            document.getElementById('market-body').innerHTML = '<tr><td colspan="5">Error loading players. Please refresh.</td></tr>';
        }
    }

    function renderMarket(data) {
        const html = data.map((p, i) => `
            <tr data-search="${p.name.toLowerCase()} ${p.county.toLowerCase()}">
                <td><b>${p.name}</b></td>
                <td>${p.county}</td>
                <td>${p.pos}</td>
                <td style="color:var(--orange); font-weight:bold;">${p.price}m</td>
                <td><button class="btn-add" onclick="addToSquad('${p.name}', '${p.pos}', ${p.price})">ADD</button></td>
            </tr>
        `).join('');
        document.getElementById('market-body').innerHTML = html;
    }

    function addToSquad(name, pos, price) {
        if (state.squad.length >= 18) return alert("Squad full (Max 18)!");
        if (state.budget < price) return alert("Not enough budget!");
        
        state.squad.push({ name, pos, price });
        state.budget -= price;
        refreshUI();
    }

    function removeFromSquad(index) {
        state.budget += state.squad[index].price;
        state.squad.splice(index, 1);
        refreshUI();
    }

    function refreshUI() {
        document.getElementById('budget-val').innerText = state.budget.toFixed(1);
        document.getElementById('count-val').innerText = state.squad.length;
        
        const list = document.getElementById('squad-list');
        if (state.squad.length === 0) {
            list.innerHTML = '<p style="color:#888; text-align:center; padding:20px;">Squad empty.</p>';
        } else {
            list.innerHTML = state.squad.map((p, i) => `
                <div class="squad-slot">
                    <span><b>${p.pos}</b>: ${p.name}</span>
                    <button class="btn-remove" onclick="removeFromSquad(${i})">Ã—</button>
                </div>
            `).join('');
        }

        document.getElementById('submission-form').style.display = (state.squad.length === 18) ? 'block' : 'none';
    }

    async function sendTeamToGoogle() {
        const mName = document.getElementById('mgr-name').value.trim();
        const tName = document.getElementById('team-name').value.trim();
        
        if (!mName || !tName) return alert("Please enter Manager and Team names!");

        const btn = document.getElementById('submit-button');
        btn.disabled = true;
        btn.innerText = "SAVING TEAM...";

        const squadString = state.squad.map(p => p.name).join(', ');

        const params = new URLSearchParams();
        params.append('managerName', mName);
        params.append('teamName', tName);
        params.append('squadList', squadString);

        try {
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                body: params
            });

            alert("SUCCESS! Your team has been saved to the Orchard Fans Database.");
            window.location.reload();
        } catch (e) {
            alert("Error connecting to Google Sheets. Please try again.");
            btn.disabled = false;
            btn.innerText = "SUBMIT SQUAD";
        }
    }

    function filterTable() {
        const term = document.getElementById('playerSearch').value.toLowerCase();
        const rows = document.querySelectorAll('#market-body tr');
        rows.forEach(row => {
            row.style.display = row.getAttribute('data-search').includes(term) ? '' : 'none';
        });
    }

    init();
</script>
</body>
</html>
