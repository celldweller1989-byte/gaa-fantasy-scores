<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAA FANTASY FOOTBALL v1.7</title>
    <style>
        :root { --orange: #f37021; --dark: #1a1a1a; --cream: #f4f1de; --white: #ffffff; --green: #2e7d32; --pitch-lines: rgba(255,255,255,0.8); --red: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--cream); margin: 0; padding: 0; }
        .header { background: var(--orange); padding: 10px; text-align: center; }
        .header img { max-height: 100px; }
        .container { padding: 10px; max-width: 1400px; margin: auto; }
        .main-layout { display: flex; flex-direction: column; gap: 15px; }
        @media (min-width: 1100px) { .main-layout { display: grid; grid-template-columns: 1fr 450px 320px; } }
        .panel { background: var(--white); border-radius: 8px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* The Market List */
        .scroll-box { max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #eee; padding: 10px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        /* Pitch Area */
        .pitch { background: var(--green); aspect-ratio: 2/3.1; border-radius: 8px; border: 3px solid white; position: relative; overflow: hidden; }
        .pitch-grid { display: flex; flex-direction: column; height: 100%; justify-content: space-around; }
        .pitch-row { display: flex; justify-content: center; gap: 10px; }
        .player-disc { width: 60px; height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .player-disc img { width: 45px; height: 45px; object-fit: contain; }
        
        .stats-popup { 
            visibility: hidden; width: 180px; background: #222; color: #fff; padding: 10px; position: absolute; 
            z-index: 999; left: 50px; border-radius: 6px; border: 1px solid var(--orange); font-size: 11px;
        }
        .market-player-cell:hover .stats-popup { visibility: visible; }
        
        .debug-btn { position: fixed; bottom: 10px; left: 10px; background: var(--red); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .version-stamp { position: fixed; bottom: 5px; right: 5px; font-size: 10px; color: #999; }
    </style>
</head>
<body>

<div class="header"><img src="https://i.postimg.cc/28yKYj7D/Chat-GPT-Image-Feb-6-2026-02-34-21-PM.png"></div>

<div class="container">
    <div class="main-layout">
        <div class="panel">
            <h3>Player Market</h3>
            <div style="margin-bottom: 10px;">
                <input type="text" id="search-name" placeholder="Search Player..." oninput="filterPlayers()" style="width: 60%; padding: 8px;">
                <select id="filter-county" onchange="filterPlayers()" style="width: 35%; padding: 8px;"><option value="">All Counties</option></select>
            </div>
            <div class="scroll-box">
                <table id="player-table">
                    <thead><tr><th>Player</th><th>Price</th><th>Action</th></tr></thead>
                    <tbody id="market-body">
                        <tr><td colspan="3" style="text-align:center; padding:40px;">Checking Spreadsheet Connection...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <div class="pitch"><div class="pitch-grid" id="pitch-board"></div></div>
            <div style="background:#222; padding:10px; border-radius: 0 0 8px 8px; display:flex; justify-content:center; gap:10px;" id="bench-list"></div>
        </div>

        <div class="panel">
            <h2 id="budget-val">100.0m</h2>
            <button onclick="saveTeam()" style="width:100%; padding:15px; background:var(--green); color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">SAVE TEAM</button>
            <button onclick="location.reload()" style="width:100%; margin-top:10px; border:1px solid #ddd; padding:5px; background:none; cursor:pointer;">Refresh Connection</button>
        </div>
    </div>
</div>

<button class="debug-btn" onclick="runDebug()">DIAGNOSE CONNECTION</button>
<div class="version-stamp">v1.7 - Ajax Loader</div>

<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcdzjZ4zYlGgFe5acS8xOb1vHR9b8i98UudIOe-iC9Z1d6x6AY5zATgX217cNjcNtAGDLJ56y8Jr8N/pub?output=csv';
    let allPlayers = [], state = { budget: 100.0, squad: [] };

    // Robust CSV Parser
    function parseCSV(str) {
        const arr = []; let quote = false;
        for (let row = col = c = 0; c < str.length; c++) {
            let cc = str[c], nc = str[c+1];
            arr[row] = arr[row] || []; arr[row][col] = arr[row][col] || '';
            if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
            if (cc == '"') { quote = !quote; continue; }
            if (cc == ',' && !quote) { ++col; continue; }
            if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }
            if (cc == '\n' && !quote) { ++row; col = 0; continue; }
            if (cc == '\r' && !quote) { ++row; col = 0; continue; }
            arr[row][col] += cc;
        }
        return arr;
    }

    async function loadPlayers() {
        const body = document.getElementById('market-body');
        try {
            const response = await fetch(SHEET_URL + '&timestamp=' + new Date().getTime());
            if (!response.ok) throw new Error('HTTP Error: ' + response.status);
            
            const data = await response.text();
            const rows = parseCSV(data);
            
            allPlayers = [];
            const counties = new Set();

            for (let i = 1; i < rows.length; i++) {
                const r = rows[i];
                if (!r[0] || r[0].length < 2) continue;

                const co = r[0].trim();
                counties.add(co);
                const pts = parseInt(r[8]) || 0;

                allPlayers.push({
                    id: i, county: co, name: (r[1] + " " + (r[2]||"")).trim(),
                    pos: (r[3] || "FWD").trim().toUpperCase(), 
                    price: Math.max(3.0, 5.5 + (pts * 0.05)),
                    app: r[7]||0, g: r[4]||0, p: r[5]||0, win: r[18]||0, loss: r[19]||0,
                    badge: r[14] ? r[14].trim() : '', total: pts
                });
            }

            const sel = document.getElementById('filter-county');
            [...counties].sort().forEach(c => { let o = document.createElement('option'); o.value=o.text=c; sel.add(o); });
            
            filterPlayers();
            updateUI();
        } catch (err) {
            body.innerHTML = `<tr><td colspan="3" style="color:red; text-align:center;"><b>Connection Blocked</b><br>${err.message}<br>Try refreshing or checking "Publish to Web" settings.</td></tr>`;
        }
    }

    function filterPlayers() {
        const nameQ = document.getElementById('search-name').value.toLowerCase();
        const coQ = document.getElementById('filter-county').value;
        const filtered = allPlayers.filter(p => p.name.toLowerCase().includes(nameQ) && (!coQ || p.county === coQ));
        
        document.getElementById('market-body').innerHTML = filtered.map(p => `
            <tr>
                <td class="market-player-cell">
                    <img src="${p.badge}" style="width:25px; vertical-align:middle; margin-right:5px;" onerror="this.src='https://ui-avatars.com/api/?name=${p.county[0]}'">
                    <b>${p.name}</b>
                    <div class="stats-popup">
                        <b>${p.name}</b><hr>
                        Apps: ${p.app} | Goals: ${p.g} | Points: ${p.p}<br>
                        Wins: ${p.win} | Losses: ${p.loss}<br>
                        <b>Season Total: ${p.total}</b>
                    </div>
                </td>
                <td>${p.price.toFixed(1)}m</td>
                <td><button onclick="addPlayer(${p.id})">+</button></td>
            </tr>
        `).join('');
    }

    function addPlayer(id) {
        const p = allPlayers.find(x => x.id === id);
        if (state.squad.length < 18 && state.budget >= p.price) {
            state.squad.push(p);
            state.budget -= p.price;
            updateUI();
        }
    }

    function updateUI() {
        document.getElementById('budget-val').innerText = `Budget: ${state.budget.toFixed(1)}m`;
        const board = document.getElementById('pitch-board');
        board.innerHTML = `<div class="pitch-row"><div class="player-disc" style="color:white">18 Player Squad Mode</div></div>`;
        // Basic pitch logic simplified for v1.7 to ensure it doesn't crash player list
    }

    function runDebug() {
        alert("Testing Link: " + SHEET_URL);
        fetch(SHEET_URL).then(() => alert("Success: Connection is open."))
        .catch(e => alert("Error: Connection blocked by your browser/firewall. Reason: " + e.message));
    }

    loadPlayers();
</script>
</body>
</html>
