<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchard Fans Fantasy GAA</title>
    <style>
        :root { --orange: #f37021; --dark: #1a1a1a; --cream: #f4f1de; --white: #ffffff; }
        body { font-family: sans-serif; background: var(--cream); margin: 0; padding: 15px; }
        .header { background: var(--orange); color: white; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
        .main-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; flex: 1; }
        .scroll-box { max-height: 500px; overflow-y: auto; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        .squad-slot { display: flex; justify-content: space-between; padding: 10px; background: #f9f9f9; margin-bottom: 5px; border-left: 4px solid var(--orange); }
        .btn { background: var(--orange); color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-reset { background: #666; margin-top: 10px; width: 100%; }
        .status-msg { padding: 10px; text-align: center; font-weight: bold; color: #666; }
        @media (max-width: 800px) { .main-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="header">
    <h1>ORCHARD FANS FANTASY GAA</h1>
    <p>Budget: <span id="budget-ui">50.0</span>m | Squad: <span id="count-ui">0</span>/18</p>
</div>

<div class="main-layout">
    <div class="panel">
        <div class="filter-row">
            <input type="text" id="search" placeholder="Search Player..." onkeyup="filter()">
            <select id="county-filter" onchange="filter()"><option value="">All Counties</option></select>
            <select id="pos-filter" onchange="filter()">
                <option value="">All Positions</option>
                <option value="GK">GK</option>
                <option value="DEF">DEF</option>
                <option value="MID">MID</option>
                <option value="FWD">FWD</option>
            </select>
        </div>
        <div class="scroll-box">
            <table id="player-table">
                <thead><tr><th>Player</th><th>Pos</th><th>Price</th><th>Add</th></tr></thead>
                <tbody id="market-body">
                    <tr><td colspan="4" class="status-msg">Attempting to load players...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <h3>My Squad</h3>
        <div id="squad-list"></div>
        <button class="btn btn-reset" onclick="resetSquad()">Reset Draft</button>
        <div id="sub-box" style="display:none; margin-top:20px;">
            <input type="text" id="mgr" placeholder="Manager Name" style="width:90%; margin-bottom:10px;">
            <input type="text" id="team" placeholder="Team Name" style="width:90%; margin-bottom:10px;">
            <button class="btn" style="width:100%; background:green;" onclick="submit()">Submit Team</button>
        </div>
    </div>
</div>

<script>
    // 1. DATA SOURCE
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcdzjZ4zYlGgFe5acS8xOb1vHR9b8i98UudIOe-iC9Z1d6x6AY5zATgX217cNjcNtAGDLJ56y8Jr8N/pub?output=csv';
    
    let players = [];
    let squad = [];
    let budget = 50.0;
    const LIMITS = { GK: 1, DEF: 6, MID: 2, FWD: 6, SUB: 3 };

    async function loadData() {
        try {
            // Using a proxy to avoid CORS issues if the direct link fails
            const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`);
            const data = await response.text();
            const rows = data.split('\n').map(row => row.split(','));
            
            players = rows.slice(1).map(cols => ({
                county: (cols[0] || '').replace(/"/g, '').trim(),
                name: ((cols[1] || '') + ' ' + (cols[2] || '')).replace(/"/g, '').trim(),
                pos: (cols[10] || '').replace(/"/g, '').trim().toUpperCase(),
                price: parseFloat(cols[11]) || 5.0
            })).filter(p => p.name.length > 2);

            // Populate counties
            const counties = [...new Set(players.map(p => p.county))].sort();
            const select = document.getElementById('county-filter');
            counties.forEach(c => select.add(new Option(c, c)));

            render();
        } catch (err) {
            document.getElementById('market-body').innerHTML = `<tr><td colspan="4" style="color:red">Error loading data. Check spreadsheet sharing.</td></tr>`;
        }
    }

    function render(filtered = players) {
        const body = document.getElementById('market-body');
        body.innerHTML = filtered.map(p => `
            <tr>
                <td><b>${p.name}</b><br><small>${p.county}</small></td>
                <td>${p.pos}</td>
                <td>${p.price.toFixed(1)}m</td>
                <td><button class="btn" onclick="add('${p.name}')">Add</button></td>
            </tr>
        `).join('');
    }

    function filter() {
        const s = document.getElementById('search').value.toLowerCase();
        const c = document.getElementById('county-filter').value;
        const p = document.getElementById('pos-filter').value;
        const f = players.filter(item => 
            item.name.toLowerCase().includes(s) && 
            (c === "" || item.county === c) && 
            (p === "" || item.pos === p)
        );
        render(f);
    }

    function add(name) {
        const p = players.find(x => x.name === name);
        if (squad.length >= 18) return alert("Squad full");
        if (budget < p.price) return alert("No budget");
        if (squad.filter(x => x.county === p.county).length >= 2) return alert("Max 2 per county");

        const posInSquad = squad.filter(x => x.role === p.pos).length;
        const subCount = squad.filter(x => x.role === 'SUB').length;

        let role = '';
        if (posInSquad < LIMITS[p.pos]) role = p.pos;
        else if (subCount < LIMITS.SUB) role = 'SUB';
        else return alert(`Slots for ${p.pos} and Subs are full.`);

        squad.push({...p, role});
        budget -= p.price;
        updateUI();
    }

    function remove(idx) {
        budget += squad[idx].price;
        squad.splice(idx, 1);
        updateUI();
    }

    function resetSquad() {
        squad = [];
        budget = 50.0;
        updateUI();
    }

    function updateUI() {
        document.getElementById('budget-ui').innerText = budget.toFixed(1);
        document.getElementById('count-ui').innerText = squad.length;
        document.getElementById('squad-list').innerHTML = squad.map((p, i) => `
            <div class="squad-slot">
                <span>[${p.role}] ${p.name}</span>
                <span style="color:red; cursor:pointer" onclick="remove(${i})">âœ–</span>
            </div>
        `).join('');
        document.getElementById('sub-box').style.display = squad.length === 18 ? 'block' : 'none';
    }

    loadData();
</script>
</body>
</html>
