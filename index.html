<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAA Fantasy - OrchardFans</title>
    <style>
        :root { --orange: #f37021; --dark: #1a1a1a; --cream: #f4f1de; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--cream); margin: 0; padding: 20px; }
        .header { background: var(--orange); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; border-bottom: 5px solid var(--dark); }
        .main-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .panel { background: var(--white); border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .stats-bar { display: flex; justify-content: space-around; font-weight: bold; margin-bottom: 10px; }
        .scroll-box { max-height: 500px; overflow-y: auto; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #f8f8f8; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .btn-add { background: var(--orange); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .squad-slot { display: flex; justify-content: space-between; background: #f9f9f9; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 4px solid var(--orange); }
        .btn-submit { background: #28a745; color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        #loading-status { text-align: center; font-weight: bold; color: var(--orange); padding: 20px; }
    </style>
</head>
<body>

<div class="header">
    <h1>ORCHARD FANS FANTASY GAA</h1>
    <div class="stats-bar">
        <span>BUDGET: <span id="budget-val">100.0</span>m</span>
        <span>SQUAD: <span id="count-val">0</span>/18</span>
    </div>
</div>

<div class="main-layout">
    <div class="panel">
        <h3>Transfer Market</h3>
        <input type="text" id="playerSearch" placeholder="Search by name or county..." onkeyup="filterTable()">
        <div id="loading-status">ðŸ“¡ Connecting to Player Database...</div>
        <div class="scroll-box">
            <table>
                <thead><tr><th>Player</th><th>County</th><th>Pos</th><th>Price</th><th>Action</th></tr></thead>
                <tbody id="market-body"></tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <h3>My 18-Man Squad</h3>
        <div id="squad-list"><p style="text-align:center;color:#888;">Add players to begin.</p></div>
        <div id="submission-form" style="display:none;">
            <input type="text" id="mgr-name" placeholder="Manager Name">
            <input type="text" id="team-name" placeholder="Team Name">
            <button id="submit-button" class="btn-submit" onclick="sendTeam()">SUBMIT SQUAD</button>
        </div>
    </div>
</div>

<script>
    const playersUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcdzjZ4zYlGgFe5acS8xOb1vHR9b8i98UudIOe-iC9Z1d6x6AY5zATgX217cNjcNtAGDLJ56y8Jr8N/pub?output=csv';
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxWGRd9S7MBrO3ST-kzLW05Ztp1FWbTgxGyk8vn8wi_fkWpbjOUwFpAajZGNMX03zLzyA/exec';

    let state = { budget: 100.0, squad: [] };
    let masterDatabase = [];

    async function loadData() {
        try {
            // Using a fetch with no-cache to ensure it's not loading a broken old version
            const response = await fetch(playersUrl + '&cache=' + Date.now());
            const csvText = await response.text();
            const rows = csvText.split('\n').filter(r => r.trim() !== '').slice(1);

            masterDatabase = rows.map(row => {
                // Handle CSV commas inside quotes correctly
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cols.length < 8) return null;
                
                const county = cols[0].replace(/"/g, '').trim();
                const fullName = (cols[1] + " " + cols[2]).replace(/"/g, '').trim();
                const pos = cols[7].replace(/"/g, '').trim();
                const pts = parseFloat(cols[5]) || 0;
                
                // Dynamic pricing based on points in your sheet
                let price = 4.5 + (pts * 0.05);
                price = Math.round(price * 2) / 2; // Rounds to nearest 0.5
                
                return { name: fullName, county, pos, price: Math.max(4.0, price) };
            }).filter(p => p !== null);

            document.getElementById('loading-status').style.display = 'none';
            renderMarket(masterDatabase);
        } catch (err) {
            document.getElementById('loading-status').innerHTML = 'âŒ Error: Document not published correctly.';
        }
    }

    function renderMarket(data) {
        document.getElementById('market-body').innerHTML = data.map(p => `
            <tr data-search="${p.name.toLowerCase()} ${p.county.toLowerCase()}">
                <td><b>${p.name}</b></td>
                <td>${p.county}</td>
                <td>${p.pos}</td>
                <td>${p.price.toFixed(1)}m</td>
                <td><button class="btn-add" onclick="add('${p.name.replace(/'/g, "\\'")}', '${p.pos}', ${p.price})">ADD</button></td>
            </tr>
        `).join('');
    }

    function add(name, pos, price) {
        if (state.squad.length >= 18) return alert("Squad full!");
        if (state.budget < price) return alert("No budget!");
        state.squad.push({name, pos, price});
        state.budget -= price;
        update();
    }

    function remove(i) {
        state.budget += state.squad[i].price;
        state.squad.splice(i, 1);
        update();
    }

    function update() {
        document.getElementById('budget-val').innerText = state.budget.toFixed(1);
        document.getElementById('count-val').innerText = state.squad.length;
        document.getElementById('squad-list').innerHTML = state.squad.map((p, i) => `
            <div class="squad-slot">
                <span><b>${p.pos}</b>: ${p.name}</span>
                <button onclick="remove(${i})" style="border:none;background:none;color:red;cursor:pointer;">âœ•</button>
            </div>
        `).join('') || '<p style="text-align:center;color:#888;">Add players.</p>';
        document.getElementById('submission-form').style.display = (state.squad.length === 18) ? 'block' : 'none';
    }

    async function sendTeam() {
        const m = document.getElementById('mgr-name').value;
        const t = document.getElementById('team-name').value;
        if (!m || !t) return alert("Enter names!");

        const btn = document.getElementById('submit-button');
        btn.disabled = true; btn.innerText = "SAVING...";

        const params = new URLSearchParams();
        params.append('managerName', m);
        params.append('teamName', t);
        params.append('squadList', state.squad.map(p => p.name).join(', '));

        try {
            await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: params });
            alert("Team saved!");
            location.reload();
        } catch (e) {
            alert("Error saving.");
            btn.disabled = false;
        }
    }

    function filterTable() {
        const q = document.getElementById('playerSearch').value.toLowerCase();
        document.querySelectorAll('#market-body tr').forEach(r => {
            r.style.display = r.getAttribute('data-search').includes(q) ? '' : 'none';
        });
    }

    loadData();
</script>
</body>
</html>
