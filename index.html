<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAA FANTASY FOOTBALL v1.6</title>
    <style>
        :root { --orange: #f37021; --dark: #1a1a1a; --cream: #f4f1de; --white: #ffffff; --green: #2e7d32; --pitch-lines: rgba(255,255,255,0.8); --red: #dc3545; --blue: #007bff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--cream); margin: 0; padding: 0; color: var(--dark); }
        .header { background: var(--orange); padding: 10px; text-align: center; }
        .header img { max-width: 100%; height: auto; max-height: 120px; border-radius: 5px; }
        nav { display: flex; justify-content: center; background: var(--dark); position: sticky; top: 0; z-index: 100; }
        .nav-link { color: white; padding: 12px 15px; text-decoration: none; font-weight: bold; cursor: pointer; border: none; background: none; font-size: 12px; text-transform: uppercase; }
        .nav-link.active { background: var(--orange); }
        .container { padding: 10px; max-width: 1400px; margin: auto; }
        .main-layout { display: flex; flex-direction: column; gap: 15px; }
        @media (min-width: 1100px) { .main-layout { display: grid; grid-template-columns: 1fr 450px 320px; } }
        .panel { background: var(--white); border-radius: 8px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .pitch { background: var(--green); width: 100%; aspect-ratio: 2/3.2; border-radius: 8px; position: relative; border: 3px solid white; overflow: hidden; }
        .pitch-grid { display: flex; flex-direction: column; height: 100%; justify-content: space-around; padding: 10px 0; position: relative; z-index: 2; }
        .pitch-row { display: flex; justify-content: center; gap: 12px; width: 100%; }
        .player-disc { width: 65px; height: 65px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .player-disc img { width: 50px; height: 50px; object-fit: contain; }
        .player-name-label { position: absolute; bottom: -12px; background: rgba(0,0,0,0.85); color: white; padding: 1px 5px; border-radius: 3px; font-size: 9px; white-space: nowrap; }
        .bench-area { background: #222; padding: 15px 10px; border-radius: 0 0 8px 8px; display: flex; justify-content: center; gap: 20px; }
        .scroll-box { max-height: 650px; overflow-y: auto; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #f8f8f8; padding: 8px; text-align: left; position: sticky; top: 0; border-bottom: 2px solid #ddd; }
        td { padding: 8px; border-bottom: 1px solid #eee; position: relative; }
        .market-player-cell { display: flex; align-items: center; cursor: help; }
        .market-badge { width: 30px; height: 30px; margin-right: 10px; }
        .stats-popup { 
            visibility: hidden; width: 190px; background: #222; color: #fff; padding: 10px; position: absolute; 
            z-index: 100; left: 110%; top: 0; border-radius: 6px; opacity: 0; transition: 0.3s; border: 1px solid var(--orange);
        }
        .market-player-cell:hover .stats-popup { visibility: visible; opacity: 1; }
        .stat-line { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .btn-pos { padding: 6px 2px; font-size: 9px; cursor: pointer; border: 1px solid #ddd; flex: 1; font-weight: bold; background: #fff; }
        .btn-pref { border-color: var(--orange); color: var(--orange); background: #fff5ee; }
        .timer-sidebar { background: var(--dark); color: #fff; padding: 12px; text-align: center; border-radius: 5px; margin-top: 15px; }
        #countdown { color: var(--orange); font-weight: bold; font-size: 16px; }
        .version-stamp { position: fixed; bottom: 5px; right: 5px; font-size: 10px; color: #999; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="header"><img src="https://i.postimg.cc/28yKYj7D/Chat-GPT-Image-Feb-6-2026-02-34-21-PM.png"></div>

<div class="container">
    <div class="main-layout">
        <div class="panel">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="search-name" placeholder="Search..." oninput="filterPlayers()" style="flex:2; padding:8px;">
                <select id="filter-county" onchange="filterPlayers()" style="flex:1; padding:8px;"><option value="">All Counties</option></select>
            </div>
            <div class="scroll-box">
                <table>
                    <thead><tr><th>Player</th><th>Price</th><th>Add</th></tr></thead>
                    <tbody id="market-body"><tr><td colspan="3" style="text-align:center;">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="pitch-container">
            <div class="pitch"><div class="pitch-grid" id="pitch-board"></div></div>
            <div class="bench-area" id="bench-list"></div>
        </div>

        <div class="panel">
            <div id="budget-val" style="font-size:22px; font-weight:bold; color:var(--green); text-align:center;">Budget: 100.0m</div>
            <div class="timer-sidebar">CLOSES: <span id="countdown">--:--:--</span></div>
            <button onclick="saveTeamToSheet()" style="width:100%; padding:15px; background:var(--green); color:white; border:none; border-radius:5px; font-weight:bold; margin-top:15px; cursor:pointer;">SAVE TRANSFERS</button>
            <button onclick="resetSquad()" style="width:100%; margin-top:10px; background:none; border:none; color:var(--red); cursor:pointer; font-size:11px;">Reset Draft</button>
        </div>
    </div>
</div>

<div class="version-stamp">v1.6 - Smart Parser</div>

<script>
    const SCORERS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcdzjZ4zYlGgFe5acS8xOb1vHR9b8i98UudIOe-iC9Z1d6x6AY5zATgX217cNjcNtAGDLJ56y8Jr8N/pub?output=csv';
    let allPlayers = [], state = { budget: 100.0, squad: [] };

    // Smart CSV Parser to handle commas inside quotes
    function parseCSV(text) {
        const result = [];
        let row = [''], i = 0, quote = false;
        for (let char of text) {
            if (char === '"') quote = !quote;
            else if (char === ',' && !quote) row[++i] = '';
            else if (char === '\n' && !quote) { result.push(row); row = ['']; i = 0; }
            else row[i] += char;
        }
        result.push(row);
        return result;
    }

    async function init() {
        try {
            const res = await fetch(SCORERS_URL + '?cb=' + Date.now());
            const text = await res.text();
            const rows = parseCSV(text);
            const counties = new Set();
            
            allPlayers = [];
            for(let i=1; i<rows.length; i++) {
                const r = rows[i];
                if(!r[0] || r[0].length < 2) continue;
                
                counties.add(r[0].trim());
                let pts = parseInt(r[8]) || 0;
                let price = Math.max(3.0, 5.5 + (pts * 0.05));

                allPlayers.push({
                    id: i, county: r[0].trim(), name: (r[1] + " " + (r[2]||"")).replace(/"/g, '').trim(),
                    pos: (r[3] || "FWD").trim().toUpperCase(), price: price,
                    g: r[4]||0, p: r[5]||0, cs: r[6]||0, app: r[7]||0, tot: pts,
                    y: r[11]||0, red: r[12]||0, badge: r[14] ? r[14].trim() : '',
                    win: r[18] || 0, loss: r[19] || 0
                });
            }
            
            const sel = document.getElementById('filter-county');
            [...counties].sort().forEach(c => { let o = document.createElement('option'); o.value=o.text=c; sel.add(o); });
            updateUI();
            filterPlayers();
        } catch (e) { document.getElementById('market-body').innerHTML = "Error loading data."; }
    }

    function filterPlayers() {
        const nameQ = document.getElementById('search-name').value.toLowerCase();
        const coQ = document.getElementById('filter-county').value;
        const filtered = allPlayers.filter(p => p.name.toLowerCase().includes(nameQ) && (!coQ || p.county === coQ));
        
        document.getElementById('market-body').innerHTML = filtered.map(p => `
            <tr>
                <td>
                    <div class="market-player-cell">
                        <img src="${p.badge}" class="market-badge" onerror="this.src='https://ui-avatars.com/api/?name=${p.county[0]}'">
                        <b>${p.name}</b>
                        <div class="stats-popup">
                            <b style="color:var(--orange)">${p.name}</b>
                            <div class="stat-line"><span>Apps:</span><span>${p.app}</span></div>
                            <div class="stat-line"><span>Goals:</span><span>${p.g}</span></div>
                            <div class="stat-line"><span>Points:</span><span>${p.p}</span></div>
                            <div class="stat-line"><span>Win:</span><span>${p.win}</span></div>
                            <div class="stat-line"><span>Loss:</span><span>${p.loss}</span></div>
                            <div class="stat-line" style="margin-top:5px; border-top:1px solid #444"><span>Total Pts:</span><span>${p.tot}</span></div>
                        </div>
                    </div>
                </td>
                <td>${p.price.toFixed(1)}m</td>
                <td style="display:flex; gap:2px;">
                    ${['GK','DEF','MID','FWD','SUB'].map(role => `<button class="btn-pos ${p.pos===role?'btn-pref':''}" onclick="addPlayer(${p.id},'${role}')">${role}</button>`).join('')}
                </td>
            </tr>
        `).join('');
    }

    function addPlayer(id, role) {
        const p = allPlayers.find(x => x.id === id);
        if (state.squad.length >= 18 || state.budget < p.price || state.squad.find(x => x.id === id)) return;
        state.squad.push({...p, role});
        state.budget -= p.price;
        updateUI();
    }

    function removePlayer(id) {
        const idx = state.squad.findIndex(x => x.id === id);
        state.budget += state.squad[idx].price;
        state.squad.splice(idx, 1);
        updateUI();
    }

    function updateUI() {
        document.getElementById('budget-val').innerText = `Budget: ${state.budget.toFixed(1)}m`;
        const rows = [{r:'GK',c:1}, {r:'DEF',c:3}, {r:'DEF',c:3}, {r:'MID',c:2}, {r:'FWD',c:3}, {r:'FWD',c:3}];
        let html = "", used = {GK:0, DEF:0, MID:0, FWD:0, SUB:0};
        
        rows.forEach(row => {
            html += `<div class="pitch-row">`;
            for(let i=0; i<row.c; i++) {
                const p = state.squad.filter(p => p.role === row.r)[used[row.r]];
                html += p ? `<div class="player-disc" onclick="removePlayer(${p.id})"><img src="${p.badge}"><div class="player-name-label">${p.name.split(' ').pop()}</div></div>` 
                          : `<div class="player-disc" style="opacity:0.3; border:1px dashed #fff; border-radius:50%; width:45px; height:45px; margin:10px;">${row.r}</div>`;
                if(p) used[row.r]++;
            }
            html += `</div>`;
        });
        document.getElementById('pitch-board').innerHTML = html;
        
        let subHtml = "";
        for(let i=0; i<3; i++) {
            const p = state.squad.filter(p => p.role === 'SUB')[i];
            subHtml += p ? `<div class="player-disc" onclick="removePlayer(${p.id})"><img src="${p.badge}"><div class="player-name-label">${p.name.split(' ').pop()}</div></div>`
                         : `<div style="width:45px; height:45px; border:1px dashed #666; border-radius:50%;"></div>`;
        }
        document.getElementById('bench-list').innerHTML = subHtml;
    }

    const deadline = new Date("Feb 13, 2026 23:00:00").getTime();
    setInterval(() => {
        const dist = deadline - Date.now();
        const d = Math.floor(dist/86400000), h = Math.floor((dist%86400000)/3600000), m = Math.floor((dist%3600000)/60000);
        document.getElementById("countdown").innerHTML = `${d}d ${h}h ${m}m`;
    }, 1000);

    function resetSquad() { state.squad = []; state.budget = 100.0; updateUI(); }
    init();
</script>
</body>
</html>
