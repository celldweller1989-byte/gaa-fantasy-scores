<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAA Fantasy - OrchardFans</title>
    <style>
        :root { --orange: #f37021; --dark: #1a1a1a; --cream: #f4f1de; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--cream); margin: 0; padding: 20px; }
        .header { background: var(--orange); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; border-bottom: 5px solid var(--dark); }
        .main-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .panel { background: var(--white); border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .stats-bar { display: flex; justify-content: space-around; font-weight: bold; }
        .scroll-box { max-height: 600px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #f8f8f8; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; z-index: 5; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.85em; }
        .btn-add { background: var(--orange); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .squad-slot { display: flex; justify-content: space-between; background: #f9f9f9; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 4px solid var(--orange); }
        .btn-submit { background: #28a745; color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .stat-tag { font-size: 0.75em; color: #666; display: block; line-height: 1.4; }
    </style>
</head>
<body>

<div class="header">
    <h1>ORCHARD FANS FANTASY GAA</h1>
    <div class="stats-bar">
        <span>BUDGET: <span id="budget-val">100.0</span>m</span>
        <span>SQUAD: <span id="count-val">0</span>/18</span>
    </div>
</div>

<div class="main-layout">
    <div class="panel">
        <h3>Transfer Market</h3>
        <input type="text" id="playerSearch" placeholder="Search by name or county..." onkeyup="filterTable()">
        <div class="scroll-box">
            <table>
                <thead><tr><th>Player</th><th>Pos</th><th>Season Stats</th><th>Price</th><th>Action</th></tr></thead>
                <tbody id="market-body"></tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <h3>My 18-Man Squad</h3>
        <div id="squad-list"></div>
        <div id="submission-form" style="display:none;">
            <p><strong>Squad Complete!</strong> Enter details to save:</p>
            <input type="text" id="mgr-name" placeholder="Manager Name">
            <input type="text" id="team-name" placeholder="Team Name">
            <button id="submit-button" class="btn-submit" onclick="sendTeam()">SUBMIT SQUAD</button>
        </div>
    </div>
</div>

<script>
    // --- SETTINGS ---
    const playersUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcdzjZ4zYlGgFe5acS8xOb1vHR9b8i98UudIOe-iC9Z1d6x6AY5zATgX217cNjcNtAGDLJ56y8Jr8N/pub?output=csv&t=' + Date.now();
    const scriptURL = 'PASTE_YOUR_NEW_DEPLOYMENT_URL_HERE'; // <--- PUT YOUR URL HERE

    let state = { budget: 100.0, squad: [] };
    let masterDatabase = [];

    async function init() {
        try {
            const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(playersUrl)}`);
            const csvText = await response.text();
            const rows = csvText.split('\n').filter(r => r.trim() !== '').slice(1);

            masterDatabase = rows.map(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cols.length < 11) return null;
                return {
                    county: cols[0].replace(/"/g, '').trim(),
                    name: (cols[1] + " " + cols[2]).replace(/"/g, '').trim(),
                    goals: cols[3].trim() || 0,
                    pts: cols[4].trim() || 0,
                    cs: cols[5].trim() || 0,
                    yellow: cols[6].trim() || 0,
                    red: cols[7].trim() || 0,
                    pos: cols[10].trim(),
                    price: parseFloat(cols[11]) || 5.0
                };
            }).filter(p => p !== null);
            
            renderMarket(masterDatabase);
        } catch (err) {
            console.error("Load failed", err);
        }
    }

    function renderMarket(data) {
        document.getElementById('market-body').innerHTML = data.map(p => `
            <tr data-search="${p.name.toLowerCase()} ${p.county.toLowerCase()}">
                <td><b>${p.name}</b><br><small>${p.county}</small></td>
                <td>${p.pos}</td>
                <td>
                    <span class="stat-tag">G: ${p.goals} | P: ${p.pts}</span>
                    <span class="stat-tag">CS: ${p.cs} | Y/R: ${p.yellow}/${p.red}</span>
                </td>
                <td style="color:var(--orange); font-weight:bold;">${p.price.toFixed(1)}m</td>
                <td><button class="btn-add" onclick="add('${p.name.replace(/'/g, "\\'")}', '${p.pos}', ${p.price})">ADD</button></td>
            </tr>
        `).join('');
    }

    function add(name, pos, price) {
        if (state.squad.length >= 18) return alert("Squad full!");
        if (state.budget < price) return alert("Budget exceeded!");
        state.squad.push({name, pos, price});
        state.budget -= price;
        update();
    }

    function remove(i) {
        state.budget += state.squad[i].price;
        state.squad.splice(i, 1);
        update();
    }

    function update() {
        document.getElementById('budget-val').innerText = state.budget.toFixed(1);
        document.getElementById('count-val').innerText = state.squad.length;
        const list = document.getElementById('squad-list');
        list.innerHTML = state.squad.map((p, i) => `
            <div class="squad-slot">
                <span><b>${p.pos}</b>: ${p.name}</span>
                <button onclick="remove(${i})" style="border:none;background:none;color:red;cursor:pointer;">âœ•</button>
            </div>
        `).join('') || '<p style="text-align:center;color:#888;">Select 18 players</p>';
        document.getElementById('submission-form').style.display = (state.squad.length === 18) ? 'block' : 'none';
    }

    async function sendTeam() {
        const mName = document.getElementById('mgr-name').value.trim();
        const tName = document.getElementById('team-name').value.trim();
        if (!mName || !tName) return alert("Fill in names!");

        const btn = document.getElementById('submit-button');
        btn.disabled = true; btn.innerText = "SAVING...";

        const params = new URLSearchParams();
        params.append('managerName', mName);
        params.append('teamName', tName);
        params.append('squadList', state.squad.map(p => p.name).join(', '));

        try {
            await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: params });
            alert("SUCCESS! Team recorded.");
            location.reload();
        } catch (e) {
            alert("Error saving.");
            btn.disabled = false;
        }
    }

    function filterTable() {
        const q = document.getElementById('playerSearch').value.toLowerCase();
        document.querySelectorAll('#market-body tr').forEach(r => {
            r.style.display = r.getAttribute('data-search').includes(q) ? '' : 'none';
        });
    }

    init();
</script>
</body>
</html>
