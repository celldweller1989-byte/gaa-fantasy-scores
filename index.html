<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchard Fans Fantasy GAA</title>
    <style>
        :root { --orange: #f37021; --dark: #1a1a1a; --cream: #f4f1de; --white: #ffffff; --green: #28a745; --red: #dc3545; --grey: #777; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--cream); margin: 0; padding: 0; color: var(--dark); }
        
        /* Navigation */
        .header { background: var(--orange); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        nav { display: flex; justify-content: center; background: var(--dark); padding: 0; position: sticky; top: 0; z-index: 100; flex-wrap: wrap; }
        .nav-link { color: white; padding: 15px 20px; text-decoration: none; font-weight: bold; cursor: pointer; transition: 0.3s; border: none; background: none; font-size: 13px; text-transform: uppercase; }
        .nav-link.active { background: var(--orange); }
        
        /* Layout */
        .container { padding: 15px; max-width: 1300px; margin: auto; }
        .main-layout { display: grid; grid-template-columns: 1fr 360px; gap: 20px; }
        .panel { background: var(--white); border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }

        /* Market Table */
        .scroll-box { max-height: 600px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #f8f8f8; padding: 12px; text-align: left; font-size: 10px; border-bottom: 2px solid #ddd; z-index: 5; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        
        /* Hover Stats Tooltip */
        .player-cell { display: flex; align-items: center; position: relative; cursor: help; }
        .tooltip { visibility: hidden; width: 160px; background: var(--dark); color: #fff; border-radius: 6px; padding: 8px; position: absolute; z-index: 100; bottom: 125%; left: 10%; opacity: 0; transition: 0.3s; font-size: 11px; }
        .player-cell:hover .tooltip { visibility: visible; opacity: 1; }

        /* Indicators */
        .county-badge { width: 30px; height: 30px; object-fit: contain; margin-right: 10px; }
        .result-badge { font-size: 9px; font-weight: bold; padding: 2px 5px; border-radius: 4px; display: inline-block; margin-top: 4px; border: 1px solid #ddd; }
        .res-win { background: #d4edda; color: #155724; }
        .res-loss { background: #f8d7da; color: #721c24; }
        .trend-up { color: var(--green); font-weight: bold; }
        .trend-down { color: var(--red); font-weight: bold; }

        /* Buttons */
        .btn-pos { border: 1px solid #ddd; background: #f9f9f9; padding: 6px 4px; border-radius: 4px; font-size: 9px; cursor: pointer; flex: 1; }
        .btn-pref { border: 2px solid var(--orange); color: var(--orange); font-weight: bold; background: #fff5ee; }
        .btn-main { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* Submissions Grid */
        .manager-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .manager-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; cursor: pointer; }
        .mini-squad { margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; display: none; }
        .manager-card.active .mini-squad { display: block; }
        .mini-player-row { display: flex; justify-content: space-between; font-size: 11px; padding: 3px 0; border-bottom: 1px dashed #eee; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="header"><h1>ORCHARD FANS FANTASY GAA</h1></div>
<nav>
    <button class="nav-link active" id="nav-market" onclick="showPage('market')">Market</button>
    <button class="nav-link" id="nav-submissions" onclick="showPage('submissions')">Submissions</button>
    <button class="nav-link" onclick="showPage('rules')">Rules</button>
</nav>

<div class="container">
    <div id="page-market" class="page">
        <div class="main-layout">
            <div class="panel">
                <div class="scroll-box">
                    <table>
                        <thead>
                            <tr>
                                <th>Player Info (Hover Stats)</th>
                                <th>Pts</th>
                                <th>Value</th>
                                <th>Assign</th>
                            </tr>
                        </thead>
                        <tbody id="market-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="panel">
                <h3>Your Squad</h3>
                <div id="pos-tracker" class="mini-player-row" style="flex-wrap: wrap; gap: 10px; margin-bottom: 10px;"></div>
                <div id="budget-val" style="font-weight:bold; color: var(--green); margin-bottom: 10px;">Budget: 100.00m</div>
                <div id="squad-list"></div>
                <button class="btn-main" style="background:var(--green); color:white;" onclick="submitTeam()">COPY SQUAD</button>
                <button class="btn-main" style="background:#eee;" onclick="resetSquad()">RESET</button>
            </div>
        </div>
    </div>

    <div id="page-submissions" class="page hidden">
        <div class="panel">
            <h2>Live Leaderboard</h2>
            <div id="submission-container" class="manager-grid">Loading...</div>
        </div>
    </div>

    <div id="page-rules" class="page hidden">
        <div class="panel">
            <h2>Rules</h2>
            <p>Big Win: +5 | Win: +2 | Loss: -2 | Big Loss: -5</p>
        </div>
    </div>
</div>

<script>
    const SCORERS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcdzjZ4zYlGgFe5acS8xOb1vHR9b8i98UudIOe-iC9Z1d6x6AY5zATgX217cNjcNtAGDLJ56y8Jr8N/pub?gid=0&single=true&output=csv';
    const SUBMISSIONS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcdzjZ4zYlGgFe5acS8xOb1vHR9b8i98UudIOe-iC9Z1d6x6AY5zATgX217cNjcNtAGDLJ56y8Jr8N/pub?gid=1045949920&single=true&output=csv';

    let allPlayers = [];
    let state = { budget: 100.0, squad: [] };
    const LIMITS = { GK: 1, DEF: 6, MID: 2, FWD: 6, SUB: 3 };

    async function init() {
        const res = await fetch(SCORERS_URL + '&t=' + Date.now());
        const text = await res.text();
        const rows = text.split('\n').map(r => r.split(','));
        
        allPlayers = rows.slice(1).map((col, i) => {
            if(!col[0]) return null;
            let resTxt = (col[9]||"").toLowerCase();
            let bonus = resTxt.includes("win") ? (resTxt.includes("big") || resTxt.includes("heavy") ? 5 : 2) : 0;
            let penalty = resTxt.includes("loss") ? (resTxt.includes("big") || resTxt.includes("heavy") ? 5 : 2) : 0;
            let totalPts = (parseInt(col[8])||0) + bonus - penalty;
            
            return {
                id: i,
                name: (col[1] + " " + col[2]).trim(),
                county: col[0].trim(),
                prefPos: (col[3]||"").trim().toUpperCase(),
                totalPts: totalPts,
                price: Math.max(3.0, 5.5 + (totalPts * 0.05)),
                result: resTxt.replace('heavy','BIG').toUpperCase(),
                badge: col[14],
                stats: `G: ${col[4]||0} | 1pt: ${col[11]||0} | 2pt: ${col[12]||0}`
            };
        }).filter(p => p !== null);
        renderMarket(allPlayers);
    }

    function renderMarket(data) {
        document.getElementById('market-body').innerHTML = data.map(p => `
            <tr>
                <td>
                    <div class="player-cell">
                        <img src="${p.badge}" class="county-badge" onerror="this.src='https://ui-avatars.com/api/?name=${p.county[0]}'">
                        <div><b>${p.name}</b><br><span class="result-badge ${p.result.includes('WIN')?'res-win':'res-loss'}">${p.result}</span></div>
                        <div class="tooltip">${p.county}<br>${p.stats}</div>
                    </div>
                </td>
                <td><span class="${p.totalPts>=0?'trend-up':'trend-down'}">${p.totalPts>=0?'▲':'▼'} ${p.totalPts}</span></td>
                <td><span class="${p.price>=5.5?'trend-up':'trend-down'}">${p.price>=5.5?'▲':'▼'} ${p.price.toFixed(2)}m</span></td>
                <td><div style="display:flex; gap:2px;">
                    ${['GK','DEF','MID','FWD','SUB'].map(r => `<button class="btn-pos ${p.prefPos===r?'btn-pref':''}" onclick="addPlayer(${p.id},'${r}')">${r}</button>`).join('')}
                </div></td>
            </tr>
        `).join('');
    }

    function addPlayer(id, role) {
        const p = allPlayers.find(x => x.id === id);
        if (state.squad.length >= 18 || state.budget < p.price || state.squad.filter(x=>x.role===role).length >= LIMITS[role] || state.squad.find(x=>x.id===id)) return alert("Check limits/budget!");
        state.squad.push({...p, role});
        state.budget -= p.price;
        updateUI();
    }

    function updateUI() {
        document.getElementById('budget-val').innerText = `Budget: ${state.budget.toFixed(2)}m`;
        document.getElementById('squad-list').innerHTML = state.squad.map((p, i) => `
            <div class="squad-slot"><span><b>[${p.role}]</b> ${p.name}</span><button onclick="removePlayer(${i})" style="color:red; border:none; background:none; cursor:pointer;">×</button></div>
        `).join('');
    }
