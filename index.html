<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAA Fantasy - OrchardFans</title>
    <style>
        :root { --orange: #f37021; --dark: #1a1a1a; --cream: #f4f1de; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--cream); margin: 0; padding: 20px; }
        .header { background: var(--orange); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; border-bottom: 5px solid var(--dark); }
        .main-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .panel { background: var(--white); border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .stats-bar { display: flex; justify-content: space-around; font-weight: bold; }
        .scroll-box { max-height: 600px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #f8f8f8; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; z-index: 5; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.85em; }
        .btn-add { background: var(--orange); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .squad-slot { display: flex; justify-content: space-between; background: #f9f9f9; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 4px solid var(--orange); }
        .btn-submit { background: #28a745; color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .stat-tag { font-size: 0.75em; color: #666; display: block; line-height: 1.4; }
    </style>
</head>
<body>

<div class="header">
    <h1>ORCHARD FANS FANTASY GAA</h1>
    <div class="stats-bar">
        <span>BUDGET: <span id="budget-val">100.0</span>m</span>
        <span>SQUAD: <span id="count-val">0</span>/18</span>
    </div>
</div>

<div class="main-layout">
    <div class="panel">
        <h3>Transfer Market</h3>
        <input type="text" id="playerSearch" placeholder="Search by name or county..." onkeyup="filterTable()">
        <div class="scroll-box">
            <table>
                <thead><tr><th>Player</th><th>Pos</th><th>Season Stats</th><th>Price</th><th>Action</th></tr></thead>
                <tbody id="market-body"></tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <h3>My 18-Man Squad</h3>
        <div id="squad-list"></div>
        <div id="submission-form" style="display:none;">
            <p><strong>Squad Complete!</strong> Enter details to save:</p>
            <input type="text" id="mgr-name" placeholder="Manager Name">
            <input type="text" id="team-name" placeholder="Team Name">
            <button id="submit-button" class="btn-submit" onclick="sendTeam()">SUBMIT SQUAD</button>
        </div>
    </div>
</div>

<script>
    // --- SETTINGS ---
    const playersUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcdzjZ4zYlGgFe5acS8xOb1vHR9b8i98UudIOe-iC9Z1d6x6AY5zATgX217cNjcNtAGDLJ56y8Jr8N/pub?output=csv&t=' + Date.now();
    
    // UPDATED WITH YOUR NEW URL
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyVpULAmK_3FrHRSod9UUqnhQ2uR0pCGOXbKOWdVjJLgtp-bU5zHbEFqWSKKiXpTK8sZw/exec';

    let state = { budget: 100.0, squad: [] };
    let masterDatabase = [];

    async function init() {
        try {
            const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(playersUrl)}`);
            const csvText = await response.text();
            const rows = csvText.split('\n').filter(r => r.trim() !== '').slice(1);

            masterDatabase = rows.map(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cols.length < 11) return null;
                return {
                    county: cols[0].replace(/"/g, '').trim(),
                    name: (cols[1] + " " + cols[2]).replace(/"/g, '').trim(),
                    goals: cols[3].trim() || 0,
                    pts: cols[4].trim() || 0,
                    cs: cols[5].trim() || 0,
                    yellow: cols[6].trim() || 0,
                    red: cols[7].trim() || 0,
                    pos: cols[10].trim(),
                    price: parseFloat(cols[11]) || 5.0
                };
            }).filter(p => p !== null);
            
            renderMarket(masterDatabase);
        } catch (err) {
            console.error("Load failed", err);
        }
    }

    function renderMarket(data) {
        document.getElementById('market-body').innerHTML = data.map(p => `
            <tr data-
